@startuml

title
MOK.6 Odblokuj konto
end title

autoactivate on

participant AccountEndpoint
participant SendingEmailEndpoint
participant "AccountManager\nTransactionAttributeType.REQUIRES_NEW" as AccountManager
control "AccountFacadeReadCommitted\nTransactionAttributeType.MANDATORY" as AccountFacadeReadCommitted
entity AccountEntity
alt account exists
autonumber
    AccountEndpoint -> AccountManager: unlockAccount(login)
        AccountManager -> AccountFacadeReadCommitted: findByLogin(login)
        return optional with account
        AccountManager -> AccountEntity: isVerified()
        return true
        AccountManager -> AccountEntity: isActive()
        return false
        AccountManager -> AccountEntity: setActive(true)
        return success
        AccountManager -> AccountFacadeReadCommitted: edit(account)
        return optional with account
    return success
    note right of AccountEndpoint
    [...]
    end note
    SendingEmailEndpoint -> AccountManager: isVerifiedAccountWithEmail(email)
        AccountManager -> AccountFacadeReadCommitted: findByEmail(email)
        return optional with account
        AccountManager -> AccountEntity: isVerified()
        return true
    return status code 200
else account does not exist
autonumber
    AccountEndpoint -> AccountManager: unlockAccount(login)
        AccountManager -> AccountFacadeReadCommitted: findByLogin(login)
        return empty optional
    return account does not exist
 else account is not verified
 autonumber
      AccountEndpoint -> AccountManager: lockAccount(login)
              AccountManager -> AccountFacadeReadCommitted: findByLogin(login)
              return optional with account
              AccountManager -> AccountEntity: isVerified()
              return false
      return account is already locked
else account is already unlocked
autonumber
     AccountEndpoint -> AccountManager: unlockAccount(login)
         AccountManager -> AccountFacadeReadCommitted: findByLogin(login)
         return optional with account
         AccountManager -> AccountEntity: isActive()
         return true
     return account is already unlocked
end
@enduml